var randomUnit=function(a,c){a||(a=2);var b=new THREE.Vector3(0,0,1),d=new THREE.Vector3(0,1,0),e=new THREE.Vector3(1,0,0);if(c)var f=(new THREE.Quaternion).setFromUnitVectors(e,c);var g=(Math.random()-.5)*Math.PI;e.applyAxisAngle(d,4*Math.acos(a*Math.random()-a/2));e.applyAxisAngle(b,g);c&&e.applyQuaternion(f);return e},distanceFunction=function(a,c){return Math.pow(a[0]-c[0],2)+Math.pow(a[1]-c[1],2)+Math.pow(a[2]-c[2],2)},orbitProto=function(a,c,b,d){this.realmom=this.mymu=0;this.orphans=[];this.planettype=
b;this.normal=c;this.age=d;this.particlematerials=this.particle=0;this.color=[];this.velocity=new THREE.Vector3;this.energy=0;this.major=100;this.mu=this.minor=0;this.eccentricity=new THREE.Vector3;this.initial=this.period=0;this.radius=a;this.xunit=new THREE.Vector3;this.yunit=new THREE.Vector3;this.true_mod=this.motion=0;0==b?(a=new THREE.MeshLambertMaterial({color:Math.floor(16777215*Math.random())}),a.transparent=!1,c=new THREE.SphereGeometry(this.radius,16,16),this.meshSetup(c,a)):(a=new THREE.MeshBasicMaterial({color:16772846}),
a.transparent=!0,a.opacity=1,c=new THREE.SphereGeometry(this.radius,16,16),this.meshSetup(c,a),b=new THREE.PointLight(16772846,3*b,150*b),b.ignore=!0,this.add(b))};orbitProto.prototype=Object.create(THREE.Mesh.prototype);orbitProto.prototype.constructor=orbitProto;orbitProto.prototype.meshSetup=function(){THREE.Mesh.apply(this,arguments)};
orbitProto.prototype.computeOrbit=function(a,c,b,d){this.debug&&(console.log(this.name),console.log("Velocity:"),console.log(a.length()),console.log("Distance:"),console.log(c.length()),console.log("Mu:"),console.log(b));this.energy=Math.pow(a.length(),2)/2-b/c.length();this.debug&&(console.log("Energy:"),console.log(this.energy));this.major=-b/(2*this.energy);this.debug&&(console.log("Major Semi-Axis:"),console.log(this.major));this.eccentricity=c.clone().multiplyScalar(Math.pow(a.length(),2)-b/
c.length());this.eccentricity.sub(a.clone().multiplyScalar(c.dot(a))).divideScalar(b);this.debug&&(console.log("Eccentricity:"),console.log(this.eccentricity));this.minor=this.major*Math.sqrt(1-Math.pow(this.eccentricity.length(),2));this.debug&&(console.log("Minor Semi-Axis:"),console.log(this.minor));0==this.eccentricity.length()?this.xunit=c.clone().normalize():this.xunit=this.eccentricity.clone().normalize();this.debug&&(console.log("X-Unit:"),console.log(this.xunit));this.yunit=this.xunit.clone().cross(a.clone().normalize()).cross(this.xunit).normalize();
this.debug&&(console.log("Y-Unit:"),console.log(this.yunit));this.motion=Math.sqrt(b/Math.pow(this.major,3));this.period=2*Math.PI*Math.sqrt(Math.pow(this.major,3)/b);this.mu=b;this.debug&&(console.log("Period:"),console.log(this.period));this.true_mod=Math.sqrt((1+this.eccentricity.length())/(1-this.eccentricity.length()));this.debug&&(console.log("True Mod:"),console.log(this.true_mod));a=c.length();a=Math.acos((1-a/this.major)/this.eccentricity.length());this.debug&&(console.log("E:"),console.log(a));
a-=this.eccentricity.length()*Math.sin(a);this.debug&&(console.log("M:"),console.log(a));isNaN(a)&&(a=0);this.initial=d-a/this.motion;this.debug&&(console.log("Initial:"),console.log(this.initial))};
orbitProto.prototype.computePosition=function(a,c){var b=(a-this.initial)%(this.period*gamespeed)/gamespeed*this.motion,d=this.eccentricity.length();if(.001>d)e=b;else{for(var e=.8<d?Math.PI:b,f=0;f<c;f++)e-=(e-d*Math.sin(e)-b)/(1-d*Math.cos(e));b=2*Math.atan(this.true_mod*Math.tan(e/2))}e=this.major*(1-d*Math.cos(e));d=this.xunit.clone().multiplyScalar(Math.cos(b)*e);e=this.yunit.clone().multiplyScalar(Math.sin(b)*e);d.add(e);this.position.x=d.x;this.position.y=d.y;this.position.z=d.z;0!=this.particle&&
this.particle.rotateOnAxis(this.normal,5E-5)};orbitProto.prototype.computeSpeed=function(a){return Math.sqrt(this.mu*(2/a-1/this.major))};orbitProto.prototype.realPosition=function(a){a||(a=new THREE.Vector3);a.applyEuler(this.rotation);a.add(this.position);return 0!=this.realmom&&this.realmom!=scene?this.realmom.realPosition(a):a};
orbitProto.prototype.generateSatellite=function(a,c,b){var d=this.major/8*(Math.random()+.5),e=Math.sqrt(this.mymu/d),d=randomUnit(2-c/1.5,this.normal).multiplyScalar(d);c=1<c?d.clone().normalize().cross(this.normal.clone().normalize()).multiplyScalar(e):randomUnit().multiplyScalar(e);a=new orbitProto(this.radius/4,this.normal.clone(),a,Math.floor(3*Math.random()));a.mymu=this.mymu/100;a.computeOrbit(c,d,this.mymu,b);a.realmom=this;b=this.color.slice();b[0]+=.3*Math.random();0>b[0]?b[0]=0:1<b[0]&&
(b[0]=1);b[2]+=.3*Math.random();0>b[2]?b[2]=0:1<b[2]&&(b[2]=1);a.enableEffects(b);this.add(a)};orbitProto.prototype.seedSystem=function(a,c){if(!(1>a)){var b=Math.floor(Math.random()*Math.pow(4,a)),d=0;2<a&&(d=1);for(var e=0;e<b;e++)this.generateSatellite(d,this.age,c),this.children[this.children.length-1].seedSystem(a-1,c)}};orbitProto.prototype.disableEffects=function(){0!=this.particle&&(this.remove(this.particle),this.particlematerials=this.particle=0)};
orbitProto.prototype.enableEffects=function(a){a?this.color=a.slice():3>this.color.length&&(a=Math.PI/2*Math.random(),a=[Math.sin(a),0,Math.cos(a)],this.color=a.slice());this.disableEffects();a=new THREE.Geometry;for(i=0;i<this.major/3;i++){var c=this.major/8*(Math.random()+.3),c=randomUnit(2-this.age/1.5,this.normal).multiplyScalar(c);a.vertices.push(c)}c=(new THREE.TextureLoader).load("img/Cloud.png");this.particlematerials=new THREE.PointsMaterial({size:this.major/1E3,map:c,blending:THREE.AdditiveBlending,
depthTest:!1,transparent:!0});this.particlematerials.color.setRGB(this.color[0],this.color[1],this.color[2]);this.particle=new THREE.Points(a,this.particlematerials);this.particle.ignore=!0;this.add(this.particle)};orbitProto.prototype.doPhysicsStep=function(a){for(var c=0;c<this.children.length;c++)this.children[c].ignore||(this.children[c].doPhysicsStep(a),this.children[c].computePosition(a,5))};orbitProto.prototype.ditchMom=function(){this.realmom.orphans.push(this);this.realmom.remove(this)};
orbitProto.prototype.findMom=function(){if(this.realmom==scene)scene.add(this);else if(scene.remove(this),0!=this.realmom){var a=this.realmom.orphans.indexOf(this);-1<a&&this.realmom.orphans.splice(a,1);this.realmom.add(this)}};orbitProto.prototype.ditchKids=function(){for(var a=0;a<this.children.length;a++)this.children[a].ignore||(this.orphans.push(this.children[a]),this.remove(this.children[a]),a--)};
orbitProto.prototype.findKids=function(){for(;0<this.orphans.length;)this.add(this.orphans.pop());this.orphans=[]};orbitProto.prototype.debug=!1;
var setFocus=function(a){console.log("P: CM, GX, CP");console.log(camera.position);console.log(galaxy.position);var c=camera.position.clone().sub(galaxy.position);console.log(c);if(0!=physicsfocus){if(0!=physicsfocus.realmom&&physicsfocus.realmom!=scene)for(var b=0;b<physicsfocus.realmom.children.length;b++)physicsfocus.realmom.children[b].ignore||physicsfocus.realmom.children[b].findKids();for(b=0;b<physicsfocus.children.length;b++)physicsfocus.children[b].ignore||physicsfocus.children[b].findKids()}selectables=
[];physicsfocus=a;selectables=[];selectables.push(a);if(0!=a.realmom&&a.realmom!=scene){selectables.push(a.realmom);0!=a.realmom.realmom&&a.realmom.realmom!=scene&&selectables.push(a.realmom.realmom);for(b=0;b<a.realmom.children.length;b++)a.realmom.children[b].ignore||(selectables.push(a.realmom.children[b]),a.realmom.children[b].ditchKids());a.findKids()}for(b=0;b<a.children.length;b++)if(!a.children[b].ignore){selectables.push(a.children[b]);for(var d=0;d<a.children[b].children.length;d++)a.children[b].children[d].ignore||
(selectables.push(a.children[b].children[d]),a.children[b].children[d].ditchKids())}a=physicsfocus.realPosition();a.x-=galaxy.position.x;a.y-=galaxy.position.y;a.z-=galaxy.position.z;a.multiplyScalar(-1);galaxy.position.x=a.x;galaxy.position.y=a.y;galaxy.position.z=a.z;c.add(galaxy.position);projectedCameraTarget.add(c).sub(camera.position);camera.position.x=c.x;camera.position.y=c.y;camera.position.z=c.z;autoCameraTarget=new THREE.Vector3(0,0,0);camera.lookAt(projectedCameraTarget);autoCameraPosition=
camera.position.clone().normalize().multiplyScalar(physicsfocus.major/16);console.log("F: CM, GX, PT, CP");console.log(camera.position);console.log(galaxy.position);console.log(projectedCameraTarget);console.log(c)};
